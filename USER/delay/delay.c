#include "delay\delay.h"
#include "sys\sys.h"
////////////////////////////////////////////////////////////////////////////////// 	 
//ï¿½ï¿½ï¿½Ê¹ï¿½ï¿½ucos,ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½.
#if SYSTEM_SUPPORT_UCOS
#include "includes.h"					//ucos Ê¹ï¿½ï¿½	  
#endif

//All rights reserved
//********************************************************************************
//V1.2ï¿½Þ¸ï¿½Ëµï¿½ï¿½
//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½ï¿½Ðµï¿½ï¿½Ã³ï¿½ï¿½ï¿½ï¿½ï¿½Ñ­ï¿½ï¿½ï¿½Ä´ï¿½ï¿½ï¿½
//ï¿½ï¿½Ö¹ï¿½ï¿½Ê±ï¿½ï¿½×¼È·,ï¿½ï¿½ï¿½ï¿½do whileï¿½á¹¹!

//V1.3ï¿½Þ¸ï¿½Ëµï¿½ï¿½
//ï¿½ï¿½ï¿½ï¿½ï¿½Ë¶ï¿½UCOSIIï¿½ï¿½Ê±ï¿½ï¿½Ö§ï¿½ï¿½.
//ï¿½ï¿½ï¿½Ê¹ï¿½ï¿½ucosII,delay_initï¿½ï¿½ï¿½Ô¶ï¿½ï¿½ï¿½ï¿½ï¿½SYSTICKï¿½ï¿½Öµ,Ê¹Ö®ï¿½ï¿½ucosï¿½ï¿½TICKS_PER_SECï¿½ï¿½Ó¦.
//delay_msï¿½ï¿½delay_usÒ²ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ucosï¿½Ä¸ï¿½ï¿½ï¿½.
//delay_usï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ucosï¿½ï¿½Ê¹ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½×¼È·ï¿½ÈºÜ¸ï¿½,ï¿½ï¿½ï¿½ï¿½Òªï¿½ï¿½ï¿½ï¿½Ã»ï¿½ï¿½Õ¼ï¿½Ã¶ï¿½ï¿½ï¿½Ä¶ï¿½Ê±ï¿½ï¿?.
//delay_msï¿½ï¿½ucosï¿½ï¿½,ï¿½ï¿½ï¿½Ôµï¿½ï¿½ï¿½OSTimeDlyï¿½ï¿½ï¿½ï¿½,ï¿½ï¿½Î´ï¿½ï¿½ï¿½ï¿½ucosÊ±,ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½delay_usÊµï¿½ï¿½,ï¿½Ó¶ï¿½×¼È·ï¿½ï¿½Ê±
//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ucosÖ®ï¿½ï¿½delay_msï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½Ä³ï¿½ï¿½ï¿½,Ñ¡ï¿½ï¿½OSTimeDlyÊµï¿½Ö»ï¿½ï¿½ï¿½delay_usÊµï¿½ï¿½.

//V1.4ï¿½Þ¸ï¿½Ëµï¿½ï¿½ 20110929
//ï¿½Þ¸ï¿½ï¿½ï¿½Ê¹ï¿½ï¿½ucos,ï¿½ï¿½ï¿½ï¿½ucosÎ´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½,delay_msï¿½ï¿½ï¿½Ð¶ï¿½ï¿½Þ·ï¿½ï¿½ï¿½Ó¦ï¿½ï¿½bug.
//V1.5ï¿½Þ¸ï¿½Ëµï¿½ï¿½ 20120902
//ï¿½ï¿½delay_usï¿½ï¿½ï¿½ï¿½ucosï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö¹ï¿½ï¿½ï¿½ï¿½ucosï¿½ï¿½ï¿½delay_usï¿½ï¿½Ö´ï¿½Ð£ï¿½ï¿½ï¿½ï¿½Üµï¿½ï¿½Âµï¿½ï¿½ï¿½Ê±ï¿½ï¿½×¼ï¿½ï¿½
////////////////////////////////////////////////////////////////////////////////// 	 
static u8  fac_us=0;//usï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
static u16 fac_ms=0;//msï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
#ifdef OS_CRITICAL_METHOD 	//ï¿½ï¿½ï¿½OS_CRITICAL_METHODï¿½ï¿½ï¿½ï¿½ï¿½ï¿½,Ëµï¿½ï¿½Ê¹ï¿½ï¿½ucosIIï¿½ï¿½.
//systickï¿½Ð¶Ï·ï¿½ï¿½ï¿½ï¿½ï¿½,Ê¹ï¿½ï¿½ucosÊ±ï¿½Ãµï¿½
void SysTick_Handler(void)
{				   
	OSIntEnter();		//ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½
    OSTimeTick();       //ï¿½ï¿½ï¿½ï¿½ucosï¿½ï¿½Ê±ï¿½Ó·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?               
    OSIntExit();        //ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð»ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½
}
#endif

//ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½Ó³Ùºï¿½ï¿½ï¿½
//ï¿½ï¿½Ê¹ï¿½ï¿½ucosï¿½ï¿½Ê±ï¿½ï¿½,ï¿½Ëºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¼ï¿½ï¿½ucosï¿½ï¿½Ê±ï¿½Ó½ï¿½ï¿½ï¿½
//SYSTICKï¿½ï¿½Ê±ï¿½Ó¹Ì¶ï¿½ÎªHCLKÊ±ï¿½Óµï¿½1/8
//SYSCLK:ÏµÍ³Ê±ï¿½ï¿½
void delay_init()	 
{

#ifdef OS_CRITICAL_METHOD 	//ï¿½ï¿½ï¿½OS_CRITICAL_METHODï¿½ï¿½ï¿½ï¿½ï¿½ï¿½,Ëµï¿½ï¿½Ê¹ï¿½ï¿½ucosIIï¿½ï¿½.
	u32 reload;
#endif
	SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK_Div8);	//Ñ¡ï¿½ï¿½ï¿½â²¿Ê±ï¿½ï¿½  HCLK/8
	fac_us=SystemCoreClock/8000000;	//ÎªÏµÍ³Ê±ï¿½Óµï¿½1/8  
	 
#ifdef OS_CRITICAL_METHOD 	//ï¿½ï¿½ï¿½OS_CRITICAL_METHODï¿½ï¿½ï¿½ï¿½ï¿½ï¿½,Ëµï¿½ï¿½Ê¹ï¿½ï¿½ucosIIï¿½ï¿½.
	reload=SystemCoreClock/8000000;		//Ã¿ï¿½ï¿½ï¿½ÓµÄ¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½Î»ÎªK	   
	reload*=1000000/OS_TICKS_PER_SEC;//ï¿½ï¿½ï¿½ï¿½OS_TICKS_PER_SECï¿½è¶¨ï¿½ï¿½ï¿½Ê±ï¿½ï¿?
							//reloadÎª24Î»ï¿½Ä´ï¿½ï¿½ï¿½,ï¿½ï¿½ï¿½Ö?:16777216,ï¿½ï¿½72Mï¿½ï¿½,Ô¼ï¿½ï¿½1.86sï¿½ï¿½ï¿½ï¿½	
	fac_ms=1000/OS_TICKS_PER_SEC;//ï¿½ï¿½ï¿½ï¿½ucosï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½Ùµï¿½Î»	   
	SysTick->CTRL|=SysTick_CTRL_TICKINT_Msk;   	//ï¿½ï¿½ï¿½ï¿½SYSTICKï¿½Ð¶ï¿½
	SysTick->LOAD=reload; 	//Ã¿1/OS_TICKS_PER_SECï¿½ï¿½ï¿½Ð¶ï¿½Ò»ï¿½ï¿½	
	SysTick->CTRL|=SysTick_CTRL_ENABLE_Msk;   	//ï¿½ï¿½ï¿½ï¿½SYSTICK    
#else
	fac_ms=(u16)fac_us*1000;//ï¿½ï¿½ucosï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½Ã¿ï¿½ï¿½msï¿½ï¿½Òªï¿½ï¿½systickÊ±ï¿½ï¿½ï¿½ï¿½   
#endif
}								    

#ifdef OS_CRITICAL_METHOD	//Ê¹ï¿½ï¿½ï¿½ï¿½ucos
//ï¿½ï¿½Ê±nus
//nusÎªÒªï¿½ï¿½Ê±ï¿½ï¿½usï¿½ï¿½.		    								   
void delay_us(u32 nus)
{		
	u32 ticks;
	u32 told,tnow,tcnt=0;
	u32 reload=SysTick->LOAD;	//LOADï¿½ï¿½Öµ	    	 
	ticks=nus*fac_us; 			//ï¿½ï¿½Òªï¿½Ä½ï¿½ï¿½ï¿½ï¿½ï¿½	  		 
	tcnt=0;
	told=SysTick->VAL;        	//ï¿½Õ½ï¿½ï¿½ï¿½Ê±ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½Öµ
	while(1)
	{
		tnow=SysTick->VAL;	
		if(tnow!=told)
		{	    
			if(tnow<told)tcnt+=told-tnow;//ï¿½ï¿½ï¿½ï¿½×¢ï¿½ï¿½Ò»ï¿½ï¿½SYSTICKï¿½ï¿½Ò»ï¿½ï¿½ï¿½Ý¼ï¿½ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í¿ï¿½ï¿½ï¿½ï¿½ï¿½.
			else tcnt+=reload-tnow+told;	    
			told=tnow;
			if(tcnt>=ticks)break;//Ê±ï¿½ä³¬ï¿½ï¿½/ï¿½ï¿½ï¿½ï¿½Òªï¿½Ó³Ùµï¿½Ê±ï¿½ï¿½,ï¿½ï¿½ï¿½Ë³ï¿½.
		}  
	}; 									    
}
//ï¿½ï¿½Ê±nms
//nms:Òªï¿½ï¿½Ê±ï¿½ï¿½msï¿½ï¿½
void delay_ms(u16 nms)
{	
	if(OSRunning==TRUE)//ï¿½ï¿½ï¿½osï¿½Ñ¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½	    
	{		  
		if(nms>=fac_ms)//ï¿½ï¿½Ê±ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ucosï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 
		{
   			OSTimeDly(nms/fac_ms);//ucosï¿½ï¿½Ê±
		}
		nms%=fac_ms;				//ucosï¿½Ñ¾ï¿½ï¿½Þ·ï¿½ï¿½á¹©ï¿½ï¿½Ã´Ð¡ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í¨ï¿½ï¿½Ê½ï¿½ï¿½Ê±    
	}
	delay_us((u32)(nms*1000));	//ï¿½ï¿½Í¨ï¿½ï¿½Ê½ï¿½ï¿½Ê±,ï¿½ï¿½Ê±ucosï¿½Þ·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½.
}
#else//ï¿½ï¿½ï¿½ï¿½ucosÊ±
//ï¿½ï¿½Ê±nus
//nusÎªÒªï¿½ï¿½Ê±ï¿½ï¿½usï¿½ï¿½.		    								   
void delay_us(u32 nus)
{		
	u32 temp;	    	 
	SysTick->LOAD=nus*fac_us; //Ê±ï¿½ï¿½ï¿½ï¿½ï¿?	  		 
	SysTick->VAL=0x00;        //ï¿½ï¿½Õ¼ï¿½ï¿½ï¿½ï¿½ï¿?
	SysTick->CTRL|=SysTick_CTRL_ENABLE_Msk ;          //ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½	 
	do
	{
		temp=SysTick->CTRL;
	}
	while(temp&0x01&&!(temp&(1<<16)));//ï¿½È´ï¿½Ê±ï¿½äµ½ï¿½ï¿½   
	SysTick->CTRL&=~SysTick_CTRL_ENABLE_Msk;       //ï¿½Ø±Õ¼ï¿½ï¿½ï¿½ï¿½ï¿½
	SysTick->VAL =0X00;       //ï¿½ï¿½Õ¼ï¿½ï¿½ï¿½ï¿½ï¿?	 
}
//ï¿½ï¿½Ê±nms
//×¢ï¿½ï¿½nmsï¿½Ä·ï¿½Î§
//SysTick->LOADÎª24Î»ï¿½Ä´ï¿½ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½ï¿½Ê±Î?:
//nms<=0xffffff*8*1000/SYSCLK
//SYSCLKï¿½ï¿½Î»ÎªHz,nmsï¿½ï¿½Î»Îªms
//ï¿½ï¿½72Mï¿½ï¿½ï¿½ï¿½ï¿½ï¿½,nms<=1864 
void delay_ms(u16 nms)
{	 		  	  
	u32 temp;		   
	SysTick->LOAD=(u32)nms*fac_ms;//Ê±ï¿½ï¿½ï¿½ï¿½ï¿?(SysTick->LOADÎª24bit)
	SysTick->VAL =0x00;           //ï¿½ï¿½Õ¼ï¿½ï¿½ï¿½ï¿½ï¿?
	SysTick->CTRL|=SysTick_CTRL_ENABLE_Msk ;          //ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½  
	do
	{
		temp=SysTick->CTRL;
	}
	while(temp&0x01&&!(temp&(1<<16)));//ï¿½È´ï¿½Ê±ï¿½äµ½ï¿½ï¿½   
	SysTick->CTRL&=~SysTick_CTRL_ENABLE_Msk;       //ï¿½Ø±Õ¼ï¿½ï¿½ï¿½ï¿½ï¿½
	SysTick->VAL =0X00;       //ï¿½ï¿½Õ¼ï¿½ï¿½ï¿½ï¿½ï¿?	  	    
} 
#endif
































